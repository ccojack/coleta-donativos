<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Coleta de Donativos</title>
    <!-- Carrega Tailwind CSS para estiliza√ß√£o f√°cil e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* Estilos b√°sicos para campos de data para melhor visualiza√ß√£o */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
    </style>
</head>
<body>

    <!-- Tela de Carregamento Inicial (Vis√≠vel por padr√£o) -->
    <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50 transition-opacity duration-300">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div>
        <p class="mt-4 text-xl font-semibold text-gray-700">Carregando Sistema...</p>
        <p class="text-sm text-gray-500 mt-1">Inicializando Firebase e autentica√ß√£o segura.</p>
    </div>

    <!-- Aplica√ß√£o Principal (Oculta por padr√£o, s√≥ aparece ap√≥s a autentica√ß√£o) -->
    <div id="main-app" class="p-4 md:p-8 max-w-6xl w-full bg-white shadow-2xl rounded-xl hidden">
        <h1 class="text-3xl font-bold text-indigo-700 mb-6 border-b pb-2">Controle de Coleta de Donativos</h1>

        <!-- Navega√ß√£o por Abas -->
        <div class="mb-4 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button onclick="setActiveTab('lancamento')" id="tab-lancamento"
                    class="tab-button py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-150">
                    Lan√ßamento
                </button>
                <button onclick="setActiveTab('visualizacao')" id="tab-visualizacao"
                    class="tab-button py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-150">
                    Visualiza√ß√£o e Relat√≥rios
                </button>
            </nav>
        </div>

        <!-- Conte√∫do das Abas -->
        <div id="tab-content-lancamento" class="tab-content">
            <!-- Formul√°rio de Donativo -->
            <form id="donativo-form" class="space-y-4 max-w-xl mx-auto">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Novo Donativo</h2>
                <!-- Respons√°vel pela Coleta -->
                <div>
                    <label for="responsavel" class="block text-sm font-medium text-gray-700">1) Respons√°vel pela Coleta</label>
                    <input type="text" id="responsavel" name="responsavel" required 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                           placeholder="Ex: Jo√£o Silva">
                </div>

                <!-- Ajudante da Coleta -->
                <div>
                    <label for="ajudante" class="block text-sm font-medium text-gray-700">2) Ajudante da Coleta</label>
                    <input type="text" id="ajudante" name="ajudante" required 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                           placeholder="Ex: Pedro Santos">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Dia da Reuni√£o -->
                    <div>
                        <label for="diaReuniao" class="block text-sm font-medium text-gray-700">3) Dia da Reuni√£o</label>
                        <select id="diaReuniao" name="diaReuniao" required 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                            <option value="">Selecione o Dia</option>
                            <option value="Quarta-feira">Quarta-feira</option>
                            <option value="S√°bado">S√°bado</option>
                        </select>
                    </div>

                    <!-- Data da Coleta (Para registrar o dia do m√™s e a data completa) -->
                    <div>
                        <label for="dataColeta" class="block text-sm font-medium text-gray-700">4) Data da Coleta (Dia do M√™s)</label>
                        <input type="date" id="dataColeta" name="dataColeta" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                </div>
                
                <!-- Valor da Contribui√ß√£o -->
                <div>
                    <label for="valor" class="block text-sm font-medium text-gray-700">5) Valor da Contribui√ß√£o (R$)</label>
                    <input type="number" id="valor" name="valor" required min="0.01" step="0.01"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                           placeholder="Ex: 50.00">
                </div>

                <!-- Destino da Contribui√ß√£o (Agora item 6) -->
                <div>
                    <label for="destino" class="block text-sm font-medium text-gray-700">6) Destino da Contribui√ß√£o</label>
                    <select id="destino" name="destino" required 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                        <option value="">Selecione o Destino</option>
                        <option value="Congrega√ß√£o Local">Congrega√ß√£o Local</option>
                        <option value="Obra Mundial">Obra Mundial</option>
                    </select>
                </div>

                <button type="submit" id="submit-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Salvar Donativo
                </button>
            </form>
        </div>

        <!-- Conte√∫do da Aba de Visualiza√ß√£o e Relat√≥rios -->
        <div id="tab-content-visualizacao" class="tab-content hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Relat√≥rios Financeiros</h2>
            
            <!-- Cards de Relat√≥rio -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Card 1: Total Geral -->
                <div class="bg-indigo-600 text-white p-5 rounded-lg shadow-xl transform transition duration-300 hover:scale-[1.02]">
                    <p class="text-sm uppercase font-semibold opacity-80">Total Geral Arrecadado</p>
                    <p id="total-geral" class="text-3xl font-bold mt-1">R$ 0,00</p>
                </div>
                <!-- Card 2: Congrega√ß√£o Local -->
                <div class="bg-white border-b-4 border-teal-500 p-5 rounded-lg shadow-xl transform transition duration-300 hover:scale-[1.02]">
                    <p class="text-sm uppercase font-semibold text-gray-500">Congrega√ß√£o Local</p>
                    <p id="total-local" class="text-2xl font-bold text-teal-600 mt-1">R$ 0,00</p>
                </div>
                <!-- Card 3: Obra Mundial -->
                <div class="bg-white border-b-4 border-orange-500 p-5 rounded-lg shadow-xl transform transition duration-300 hover:scale-[1.02]">
                    <p class="text-sm uppercase font-semibold text-gray-500">Obra Mundial</p>
                    <p id="total-mundial" class="text-2xl font-bold text-orange-600 mt-1">R$ 0,00</p>
                </div>
            </div>

            <h3 class="text-lg font-medium text-gray-800 mb-4 border-t pt-4">Donativos Lan√ßados</h3>

            <div id="dados-loading" class="text-center p-8 text-gray-500">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-400 mx-auto"></div>
                <p class="mt-2">Carregando dados...</p>
            </div>

            <div id="donativos-table-container" class="overflow-x-auto shadow-md rounded-lg hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Data</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Respons√°vel/Ajudante</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Reuni√£o</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Destino</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-indigo-700 uppercase tracking-wider">Valor (R$)</th>
                        </tr>
                    </thead>
                    <tbody id="donativos-body" class="bg-white divide-y divide-gray-200">
                        <!-- Linhas de Donativos ser√£o inseridas aqui pelo JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <p id="donativos-empty" class="text-center p-8 text-gray-500 hidden">Nenhum donativo encontrado. Comece a lan√ßar dados na aba 'Lan√ßamento'.</p>
        </div>
        
        <!-- √Årea de Status de Autentica√ß√£o/Sistema e Mensagens -->
        <div class="mt-8 pt-4 border-t border-gray-200">
            <div id="system-messages" class="mb-4 hidden p-3 rounded-md text-sm transition duration-300 ease-in-out"></div>

            <div class="bg-gray-50 border-l-4 border-gray-400 p-3 rounded-lg">
                <p class="text-sm text-gray-700 mt-1">ID do Usu√°rio Ativo:</p>
                <code id="user-id-display" class="block mt-1 bg-gray-100 rounded text-gray-900 font-mono break-all text-xs p-1">Aguardando ID...</code>
            </div>
        </div>
    </div>

    <!-- Scripts do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, addDoc, serverTimestamp, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configura o n√≠vel de log do Firestore para DEBUG para ajudar na depura√ß√£o
        setLogLevel('Debug');

        let app, db, auth;
        let userId = null;
        let activeTab = 'lancamento'; // Estado da aba ativa
        const COLLECTION_NAME = "donativos";
        
        // Elementos UI
        const messagesEl = document.getElementById('system-messages');
        const formEl = document.getElementById('donativo-form');
        const submitButtonEl = document.getElementById('submit-button');
        const donativosBodyEl = document.getElementById('donativos-body');
        const dadosLoadingEl = document.getElementById('dados-loading');
        const donativosTableContainerEl = document.getElementById('donativos-table-container');
        const donativosEmptyEl = document.getElementById('donativos-empty');
        
        // Novos elementos para os relat√≥rios
        const totalGeralEl = document.getElementById('total-geral');
        const totalLocalEl = document.getElementById('total-local');
        const totalMundialEl = document.getElementById('total-mundial');


        // Fun√ß√µes de UI
        // ---------------------------------------------------------------------

        // Fun√ß√£o de utilidade para formatar valores como moeda BRL
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        // Fun√ß√£o de utilidade para exibir mensagens na UI
        function showMessage(message, type = 'success') {
            messagesEl.textContent = message;
            messagesEl.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'border-red-400', 'border-green-400');
            
            if (type === 'success') {
                messagesEl.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
            } else if (type === 'error') {
                messagesEl.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
            }
            
            // Oculta a mensagem ap√≥s 5 segundos
            setTimeout(() => {
                messagesEl.classList.add('hidden');
            }, 5000);
        }

        /**
         * Alterna entre as abas e atualiza o estilo do bot√£o.
         * @param {string} tabName - Nome da aba a ser ativada ('lancamento' ou 'visualizacao').
         */
        window.setActiveTab = (tabName) => {
            activeTab = tabName;
            
            // Atualiza os estilos dos bot√µes
            document.querySelectorAll('.tab-button').forEach(button => {
                const isActive = button.id === `tab-${tabName}`;
                button.classList.toggle('bg-indigo-600', isActive);
                button.classList.toggle('text-white', isActive);
                button.classList.toggle('bg-gray-100', !isActive);
                button.classList.toggle('text-gray-600', !isActive);
            });

            // Atualiza a visibilidade do conte√∫do
            document.querySelectorAll('.tab-content').forEach(content => {
                const isVisible = content.id === `tab-content-${tabName}`;
                content.classList.toggle('hidden', !isVisible);
            });
        };


        // Fun√ß√µes de Dados (Firebase)
        // ---------------------------------------------------------------------

        /**
         * Atualiza os cart√µes de resumo com os totais calculados.
         * @param {number} geral - Total geral.
         * @param {number} local - Total para Congrega√ß√£o Local.
         * @param {number} mundial - Total para Obra Mundial.
         */
        function updateReportCards(geral, local, mundial) {
            totalGeralEl.textContent = formatCurrency(geral);
            totalLocalEl.textContent = formatCurrency(local);
            totalMundialEl.textContent = formatCurrency(mundial);
        }

        /**
         * Renderiza a lista de donativos na tabela e calcula os relat√≥rios.
         * @param {Array<Object>} donativos - Array de donativos com a chave 'id'.
         */
        function renderDonativos(donativos) {
            let totalGeral = 0;
            let totalLocal = 0;
            let totalMundial = 0;

            donativosBodyEl.innerHTML = ''; // Limpa a tabela
            
            if (donativos.length === 0) {
                // Se n√£o houver dados, reseta os cart√µes
                updateReportCards(0, 0, 0); 

                donativosTableContainerEl.classList.add('hidden');
                donativosEmptyEl.classList.remove('hidden');
                dadosLoadingEl.classList.add('hidden');
                return;
            }

            // Ordena os donativos pela data (do mais recente para o mais antigo)
            donativos.sort((a, b) => new Date(b.dataColeta) - new Date(a.dataColeta));
            
            donativos.forEach(doc => {
                const valor = doc.valor || 0; // Garante que o valor √© um n√∫mero (fallback 0)
                
                // 1. Agrega√ß√£o dos Totais
                totalGeral += valor;
                if (doc.destino === 'Congrega√ß√£o Local') {
                    totalLocal += valor;
                } else if (doc.destino === 'Obra Mundial') {
                    totalMundial += valor;
                }

                // 2. Renderiza√ß√£o da Tabela
                const dataFormatada = new Date(doc.dataColeta + 'T00:00:00').toLocaleDateString('pt-BR');
                const valorFormatado = formatCurrency(valor);
                
                const newRow = document.createElement('tr');
                newRow.classList.add('hover:bg-indigo-50', 'transition', 'duration-100');
                
                newRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${dataFormatada}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.responsavel} / ${doc.ajudante}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.diaReuniao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.destino}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-right text-indigo-800">${valorFormatado}</td>
                `;
                donativosBodyEl.appendChild(newRow);
            });

            // 3. Atualiza os Cart√µes de Relat√≥rio
            updateReportCards(totalGeral, totalLocal, totalMundial);

            dadosLoadingEl.classList.add('hidden');
            donativosTableContainerEl.classList.remove('hidden');
            donativosEmptyEl.classList.add('hidden');
        }

        /**
         * Configura o listener em tempo real para os donativos (onSnapshot).
         */
        function setupDonativosListener() {
            if (!db || !userId) {
                console.error("Firestore ou UserID n√£o dispon√≠vel para o listener.");
                return;
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const collectionPath = `/artifacts/${appId}/users/${userId}/${COLLECTION_NAME}`;
            
            // Cria a query da cole√ß√£o
            const donativosQuery = query(collection(db, collectionPath));

            // Configura o onSnapshot
            onSnapshot(donativosQuery, (snapshot) => {
                const donativos = [];
                snapshot.forEach(doc => {
                    // Mapeia o documento para incluir o ID
                    donativos.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                console.log(`Dados atualizados: ${donativos.length} donativos.`);
                renderDonativos(donativos); // Chama a fun√ß√£o de processamento/renderiza√ß√£o
            }, (error) => {
                console.error("Erro ao obter donativos em tempo real:", error);
                showMessage(`Erro ao carregar lista de donativos: ${error.message}`, 'error');
                dadosLoadingEl.classList.add('hidden');
                donativosEmptyEl.classList.remove('hidden');
            });
        }


        /**
         * Salva os dados do formul√°rio no Firestore.
         */
        async function salvarDonativo(event) {
            event.preventDefault();
            
            if (!userId || !db) {
                showMessage("Erro: O sistema ainda n√£o est√° pronto ou o usu√°rio n√£o est√° autenticado.", 'error');
                return;
            }

            submitButtonEl.disabled = true;
            submitButtonEl.textContent = "Salvando...";
            
            try {
                // Captura os dados do formul√°rio
                const donativoData = {
                    responsavel: document.getElementById('responsavel').value,
                    ajudante: document.getElementById('ajudante').value,
                    diaReuniao: document.getElementById('diaReuniao').value,
                    dataColeta: document.getElementById('dataColeta').value, // Formato YYYY-MM-DD
                    // IMPORTANT: Sempre converte para float (n√∫mero) antes de salvar
                    valor: parseFloat(document.getElementById('valor').value) || 0, 
                    destino: document.getElementById('destino').value,
                    
                    // Metadados importantes para o Firestore
                    userId: userId,
                    createdAt: serverTimestamp() 
                };

                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                // Define o caminho da cole√ß√£o privada
                const collectionPath = `/artifacts/${appId}/users/${userId}/${COLLECTION_NAME}`;
                
                // Adiciona o novo documento √† cole√ß√£o
                await addDoc(collection(db, collectionPath), donativoData);
                
                showMessage("Donativo salvo com sucesso! Veja os relat√≥rios e a lista atualizada na aba 'Visualiza√ß√£o'.", 'success');
                formEl.reset(); // Limpa o formul√°rio ap√≥s o sucesso

            } catch (error) {
                console.error("ERRO AO SALVAR DONATIVO:", error);
                showMessage(`Erro ao salvar: ${error.message}`, 'error');
            } finally {
                submitButtonEl.disabled = false;
                submitButtonEl.textContent = "Salvar Donativo";
            }
        }


        // Fun√ß√µes de Inicializa√ß√£o e Autentica√ß√£o
        // ---------------------------------------------------------------------

        /**
         * Tenta fazer o login com o token personalizado usando Exponential Backoff.
         */
        async function signInWithBackoff(auth, token, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    console.log(`Tentativa de login ${i + 1}...`);
                    if (token) {
                        return await signInWithCustomToken(auth, token);
                    } else {
                        return await signInAnonymously(auth);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; 
                    }
                    console.warn(`Falha na tentativa ${i + 1}. Tentando novamente em ${delay / 1000}s.`, error.message);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
        }

        /**
         * Inicializa o Firebase, o Firestore e a Autentica√ß√£o.
         */
        async function initializeFirebaseAndAuth() {
            try {
                // 1. Configura√ß√µes Globais (MANDAT√ìRIO)
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    // Exibe a tela de erro se a configura√ß√£o estiver faltando (comum no GitHub)
                    throw new Error("Configura√ß√£o do Firebase n√£o encontrada ou vazia. Por favor, forne√ßa sua configura√ß√£o para rodar fora do Canvas.");
                }

                // 2. Inicializa App e Servi√ßos
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                window.db = db;
                window.auth = auth;

                // 3. Listener de Estado de Autentica√ß√£o (CRUCIAL)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // Armazena o ID do usu√°rio
                        console.log("SUCESSO: Usu√°rio autenticado:", userId);
                        
                        // 4. Se a autentica√ß√£o estiver pronta, esconde a tela de loading
                        document.getElementById('user-id-display').textContent = userId;
                        document.getElementById('loading-screen').classList.add('opacity-0');
                        setTimeout(() => {
                            document.getElementById('loading-screen').classList.add('hidden');
                            document.getElementById('main-app').classList.remove('hidden');
                            
                            // 5. Configura Listeners de Eventos e de Dados AP√ìS o carregamento da APP
                            formEl.addEventListener('submit', salvarDonativo);
                            setupDonativosListener(); // INICIA O LISTENER DE DADOS
                            setActiveTab('lancamento'); // Define a aba inicial
                        }, 300); 
                    } else {
                        console.log("Estado de autentica√ß√£o alterado para n√£o logado.");
                    }
                });

                // 4. Tentativa de Login Inicial
                if (initialAuthToken) {
                    await signInWithBackoff(auth, initialAuthToken);
                } else {
                    console.log("Token de autentica√ß√£o n√£o dispon√≠vel. Tentando login an√¥nimo...");
                    await signInWithBackoff(auth, null); // Faz login an√¥nimo
                }

            } catch (error) {
                console.error("ERRO FATAL NA INICIALIZA√á√ÉO:", error);
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.classList.remove('opacity-0', 'hidden'); 
                loadingScreen.innerHTML = `
                    <div class="p-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg max-w-sm text-center shadow-lg">
                        <h2 class="text-xl font-bold mb-2">üö® ERRO FATAL DE SISTEMA</h2>
                        <p class="text-sm">Falha ao inicializar o Firebase. Verifique o console para detalhes t√©cnicos. Causa: ${error.message}</p>
                    </div>
                `;
            }
        }

        window.addEventListener('load', initializeFirebaseAndAuth);

    </script>
</body>
</html>
