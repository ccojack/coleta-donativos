<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Corre√ß√£o Firebase</title>
    <!-- Carrega Tailwind CSS para estiliza√ß√£o f√°cil e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
    </style>
</head>
<body>

    <!-- Tela de Carregamento Inicial (Vis√≠vel por padr√£o) -->
    <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50 transition-opacity duration-300">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div>
        <p class="mt-4 text-xl font-semibold text-gray-700">Carregando Sistema...</p>
        <p class="text-sm text-gray-500 mt-1">Inicializando Firebase e autentica√ß√£o segura.</p>
    </div>

    <!-- Aplica√ß√£o Principal (Oculta por padr√£o, s√≥ aparece ap√≥s a autentica√ß√£o) -->
    <div id="main-app" class="p-8 max-w-4xl w-full bg-white shadow-2xl rounded-xl hidden">
        <h1 class="text-3xl font-bold text-indigo-700 mb-4 border-b pb-2">Aplica√ß√£o Principal Carregada</h1>
        <p class="text-gray-700 mb-4">A tela de carregamento foi removida com sucesso. Isso confirma que a inicializa√ß√£o e a autentica√ß√£o do Firebase ocorreram sem erros.</p>
        
        <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded-lg">
            <h2 class="text-lg font-semibold text-green-800">Status de Autentica√ß√£o: SUCESSO!</h2>
            <p class="text-sm text-green-700 mt-1">ID do Usu√°rio Ativo (Confirma√ß√£o de Login):</p>
            <code id="user-id-display" class="block mt-2 p-2 bg-green-100 rounded text-green-900 font-mono break-all text-xs">Aguardando ID...</code>
        </div>
        
        <p class="mt-6 text-gray-600 text-sm">Agora podemos adicionar a l√≥gica da sua aplica√ß√£o, como a leitura e grava√ß√£o no Firestore.</p>
    </div>

    <!-- Scripts do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Configura o n√≠vel de log do Firestore para DEBUG para ajudar na depura√ß√£o
        setLogLevel('Debug');

        let app, db, auth;
        let isAuthReady = false;

        // Fun√ß√£o de utilidade para a convers√£o de Base64 para ArrayBuffer
        // Necess√°rio apenas se voc√™ for lidar com dados bin√°rios no futuro, mas mantido como boa pr√°tica
        function base64ToArrayBuffer(base64) {
            const binary_string = window.atob(base64);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes.buffer;
        }

        /**
         * Tenta fazer o login com o token personalizado usando Exponential Backoff.
         * Garante resili√™ncia contra falhas tempor√°rias de rede.
         */
        async function signInWithBackoff(auth, token, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    console.log(`Tentativa de login ${i + 1}...`);
                    if (token) {
                        return await signInWithCustomToken(auth, token);
                    } else {
                        return await signInAnonymously(auth);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; // Lan√ßa o erro na √∫ltima tentativa
                    }
                    console.warn(`Falha na tentativa ${i + 1}. Tentando novamente em ${delay / 1000}s.`, error.message);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Dobra o atraso
                }
            }
        }

        /**
         * Inicializa o Firebase, o Firestore e a Autentica√ß√£o.
         * √â o passo crucial para resolver o erro "Carregando Sistema".
         */
        async function initializeFirebaseAndAuth() {
            try {
                // 1. Configura√ß√µes Globais (MANDAT√ìRIO)
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Configura√ß√£o do Firebase n√£o encontrada ou vazia.");
                }

                // 2. Inicializa App e Servi√ßos
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Expondo servi√ßos globalmente para uso futuro (melhor pr√°tica seria usar fun√ß√µes)
                window.db = db;
                window.auth = auth;

                // 3. Listener de Estado de Autentica√ß√£o (CRUCIAL)
                // O onAuthStateChanged √© o que realmente garante que o processo de login terminou.
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("SUCESSO: Usu√°rio autenticado:", user.uid);
                        // 4. Se a autentica√ß√£o estiver pronta, esconde a tela de loading
                        document.getElementById('user-id-display').textContent = user.uid;
                        document.getElementById('loading-screen').classList.add('opacity-0');
                        setTimeout(() => {
                            document.getElementById('loading-screen').classList.add('hidden');
                            document.getElementById('main-app').classList.remove('hidden');
                        }, 300); // Atraso para a transi√ß√£o de opacidade
                    } else {
                        // Isso pode acontecer se o token inicial falhar, voltando para o estado n√£o logado.
                        // Mantemos a tela de carregamento at√© tentarmos o sign-in abaixo.
                        console.log("Estado de autentica√ß√£o alterado para n√£o logado.");
                    }
                    isAuthReady = true; // Sinaliza que o listener foi executado
                });

                // 4. Tentativa de Login Inicial
                if (initialAuthToken) {
                    await signInWithBackoff(auth, initialAuthToken);
                } else {
                    console.log("Token de autentica√ß√£o n√£o dispon√≠vel. Tentando login an√¥nimo...");
                    await signInWithBackoff(auth, null); // Faz login an√¥nimo
                }

            } catch (error) {
                console.error("ERRO FATAL NA INICIALIZA√á√ÉO:", error);
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.classList.remove('opacity-0', 'hidden'); // Garante que a tela de loading esteja vis√≠vel para mostrar o erro
                loadingScreen.innerHTML = `
                    <div class="p-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg max-w-sm text-center shadow-lg">
                        <h2 class="text-xl font-bold mb-2">üö® ERRO FATAL DE SISTEMA</h2>
                        <p class="text-sm">Falha ao inicializar o Firebase. Verifique o console para detalhes t√©cnicos.</p>
                        <p class="mt-3 text-xs font-mono break-all">${error.message}</p>
                    </div>
                `;
            }
        }

        window.addEventListener('load', initializeFirebaseAndAuth);

    </script>
</body>
</html>
