<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Coleta de Donativos</title>
    <!-- Carrega Tailwind CSS para estilização fácil e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        /* Estilos básicos para campos de data para melhor visualização */
        input[type="date"]::-webkit-calendar-picker-indicator,
        input[type="month"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
        /* Estilo para garantir que o modal cubra tudo */
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>

    <!-- Tela de Carregamento Inicial (Visível por padrão) -->
    <div id="loading-screen" class="fixed inset-0 flex flex-col items-center justify-center bg-white z-50 transition-opacity duration-300">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-indigo-600"></div>
        <p class="mt-4 text-xl font-semibold text-gray-700">Carregando Sistema...</p>
        <p class="text-sm text-gray-500 mt-1">Inicializando Firebase e autenticação segura.</p>
    </div>

    <!-- Aplicação Principal (Oculta por padrão, só aparece após a autenticação) -->
    <div id="main-app" class="p-4 md:p-8 max-w-6xl w-full bg-white shadow-2xl rounded-xl hidden">
        <h1 class="text-3xl font-bold text-indigo-700 mb-6 border-b pb-2">Controle de Coleta de Donativos</h1>

        <!-- Navegação por Abas -->
        <div class="mb-4 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button onclick="setActiveTab('lancamento')" id="tab-lancamento"
                    class="tab-button py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-150">
                    Lançamento
                </button>
                <button onclick="setActiveTab('visualizacao')" id="tab-visualizacao"
                    class="tab-button py-2 px-4 text-sm font-medium rounded-t-lg transition-colors duration-150">
                    Visualização e Relatórios
                </button>
            </nav>
        </div>

        <!-- Conteúdo das Abas -->
        <div id="tab-content-lancamento" class="tab-content">
            <!-- Formulário de Donativo -->
            <form id="donativo-form" class="space-y-4 max-w-xl mx-auto">
                <h2 class="text-xl font-semibold text-gray-800 mb-4">Novo Donativo</h2>
                <!-- Responsável pela Coleta -->
                <div>
                    <label for="responsavel" class="block text-sm font-medium text-gray-700">1) Responsável pela Coleta</label>
                    <input type="text" id="responsavel" name="responsavel" required 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                           placeholder="Ex: João Silva">
                </div>

                <!-- Ajudante da Coleta -->
                <div>
                    <label for="ajudante" class="block text-sm font-medium text-gray-700">2) Ajudante da Coleta</label>
                    <input type="text" id="ajudante" name="ajudante" required 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                           placeholder="Ex: Pedro Santos">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Dia da Reunião -->
                    <div>
                        <label for="diaReuniao" class="block text-sm font-medium text-gray-700">3) Dia da Reunião</label>
                        <select id="diaReuniao" name="diaReuniao" required 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                            <option value="">Selecione o Dia</option>
                            <option value="Quarta-feira">Quarta-feira</option>
                            <option value="Sábado">Sábado</option>
                        </select>
                    </div>

                    <!-- Data da Coleta (Para registrar o dia do mês e a data completa) -->
                    <div>
                        <label for="dataColeta" class="block text-sm font-medium text-gray-700">4) Data da Coleta (Dia do Mês)</label>
                        <input type="date" id="dataColeta" name="dataColeta" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                </div>
                
                <!-- Valor da Contribuição -->
                <div>
                    <label for="valor" class="block text-sm font-medium text-gray-700">5) Valor da Contribuição (R$)</label>
                    <input type="number" id="valor" name="valor" required min="0.01" step="0.01"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border"
                           placeholder="Ex: 50.00">
                </div>

                <!-- Destino da Contribuição (Agora item 6) -->
                <div>
                    <label for="destino" class="block text-sm font-medium text-gray-700">6) Destino da Contribuição</label>
                    <select id="destino" name="destino" required 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                        <option value="">Selecione o Destino</option>
                        <option value="Congregação Local">Congregação Local</option>
                        <option value="Obra Mundial">Obra Mundial</option>
                    </select>
                </div>

                <button type="submit" id="submit-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Salvar Donativo
                </button>
            </form>
        </div>

        <!-- Conteúdo da Aba de Visualização e Relatórios -->
        <div id="tab-content-visualizacao" class="tab-content hidden">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Relatórios Financeiros</h2>
            
            <!-- Controles de Filtro e Exportação -->
            <div class="flex flex-col md:flex-row items-end md:items-center space-y-3 md:space-y-0 md:space-x-4 mb-6 p-4 bg-gray-50 border rounded-lg">
                <div class="flex-grow w-full md:w-auto">
                    <label for="filter-month-year" class="block text-sm font-medium text-gray-700">Filtrar por Mês e Ano</label>
                    <!-- O formato é YYYY-MM -->
                    <input type="month" id="filter-month-year" 
                           class="mt-1 block w-full md:w-48 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>
                
                <button onclick="applyFilter()" id="filter-button" 
                        class="w-full md:w-auto py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition duration-150 ease-in-out">
                    Aplicar Filtro
                </button>
                <button onclick="resetFilter()" id="reset-button" 
                        class="w-full md:w-auto py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150 ease-in-out">
                    Resetar
                </button>
                
                <!-- Botão de Exportação para CSV (NOVO) -->
                <button onclick="exportToCSV()" 
                        class="w-full md:w-auto py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                    Exportar para CSV
                </button>
            </div>


            <!-- Cards de Relatório -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- Card 1: Total Geral -->
                <div class="bg-indigo-600 text-white p-5 rounded-lg shadow-xl transform transition duration-300 hover:scale-[1.02]">
                    <p class="text-sm uppercase font-semibold opacity-80">Total Geral Arrecadado</p>
                    <p id="total-geral" class="text-3xl font-bold mt-1">R$ 0,00</p>
                </div>
                <!-- Card 2: Congregação Local -->
                <div class="bg-white border-b-4 border-teal-500 p-5 rounded-lg shadow-xl transform transition duration-300 hover:scale-[1.02]">
                    <p class="text-sm uppercase font-semibold text-gray-500">Congregação Local</p>
                    <p id="total-local" class="text-2xl font-bold text-teal-600 mt-1">R$ 0,00</p>
                </div>
                <!-- Card 3: Obra Mundial -->
                <div class="bg-white border-b-4 border-orange-500 p-5 rounded-lg shadow-xl transform transition duration-300 hover:scale-[1.02]">
                    <p class="text-sm uppercase font-semibold text-gray-500">Obra Mundial</p>
                    <p id="total-mundial" class="text-2xl font-bold text-orange-600 mt-1">R$ 0,00</p>
                </div>
            </div>

            <h3 class="text-lg font-medium text-gray-800 mb-4 border-t pt-4">Donativos Lançados</h3>

            <div id="dados-loading" class="text-center p-8 text-gray-500">
                <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-400 mx-auto"></div>
                <p class="mt-2">Carregando dados...</p>
            </div>

            <div id="donativos-table-container" class="overflow-x-auto shadow-md rounded-lg hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Data</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Responsável/Ajudante</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Reunião</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">Destino</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-indigo-700 uppercase tracking-wider">Valor (R$)</th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-indigo-700 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="donativos-body" class="bg-white divide-y divide-gray-200">
                        <!-- Linhas de Donativos serão inseridas aqui pelo JavaScript -->
                    </tbody>
                </table>
            </div>
            
            <p id="donativos-empty" class="text-center p-8 text-gray-500 hidden">Nenhum donativo encontrado. Comece a lançar dados na aba 'Lançamento'.</p>
            <p id="donativos-filtered-empty" class="text-center p-8 text-gray-500 hidden">Nenhum donativo encontrado para o filtro selecionado.</p>
        </div>
        
        <!-- Área de Status de Autenticação/Sistema e Mensagens -->
        <div class="mt-8 pt-4 border-t border-gray-200">
            <div id="system-messages" class="mb-4 hidden p-3 rounded-md text-sm transition duration-300 ease-in-out"></div>

            <div class="bg-gray-50 border-l-4 border-gray-400 p-3 rounded-lg">
                <p class="text-sm text-gray-700 mt-1">ID do Usuário Ativo:</p>
                <code id="user-id-display" class="block mt-1 bg-gray-100 rounded text-gray-900 font-mono break-all text-xs p-1">Aguardando ID...</code>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div id="edit-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-lg transform transition-all duration-300 scale-95 opacity-0" id="edit-modal-content">
            <h2 class="text-2xl font-bold text-indigo-700 mb-6 border-b pb-2">Editar Donativo</h2>
            
            <form id="edit-donativo-form" class="space-y-4">
                <input type="hidden" id="edit-donativo-id">
                
                <!-- Responsável pela Coleta -->
                <div>
                    <label for="edit-responsavel" class="block text-sm font-medium text-gray-700">Responsável pela Coleta</label>
                    <input type="text" id="edit-responsavel" required 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>

                <!-- Ajudante da Coleta -->
                <div>
                    <label for="edit-ajudante" class="block text-sm font-medium text-gray-700">Ajudante da Coleta</label>
                    <input type="text" id="edit-ajudante" required 
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Dia da Reunião -->
                    <div>
                        <label for="edit-diaReuniao" class="block text-sm font-medium text-gray-700">Dia da Reunião</label>
                        <select id="edit-diaReuniao" required 
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                            <option value="Quarta-feira">Quarta-feira</option>
                            <option value="Sábado">Sábado</option>
                        </select>
                    </div>

                    <!-- Data da Coleta -->
                    <div>
                        <label for="edit-dataColeta" class="block text-sm font-medium text-gray-700">Data da Coleta (Dia do Mês)</label>
                        <input type="date" id="edit-dataColeta" required 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                    </div>
                </div>
                
                <!-- Valor da Contribuição -->
                <div>
                    <label for="edit-valor" class="block text-sm font-medium text-gray-700">Valor da Contribuição (R$)</label>
                    <input type="number" id="edit-valor" required min="0.01" step="0.01"
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">
                </div>

                <!-- Destino da Contribuição -->
                <div>
                    <label for="edit-destino" class="block text-sm font-medium text-gray-700">Destino da Contribuição</label>
                    <select id="edit-destino" required 
                            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border bg-white">
                        <option value="Congregação Local">Congregação Local</option>
                        <option value="Obra Mundial">Obra Mundial</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeEditModal()" class="py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                        Cancelar
                    </button>
                    <button type="submit" id="save-edit-button" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 transition duration-150">
                        Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
    <!-- Fim do Modal de Edição -->


    <!-- Scripts do Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, addDoc, serverTimestamp, onSnapshot, query, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- INÍCIO: BLOCO DE CONFIGURAÇÃO PARA USO EXTERNO ---
        // Se você estiver executando este arquivo fora do ambiente Canvas (como no GitHub Pages),
        // INSIRA SUAS CREDENCIAIS DO FIREBASE AQUI.

        // NOTA: Para este app funcionar fora do Canvas, você precisará:
        // 1. Criar um projeto no Firebase.
        // 2. Habilitar o Firestore e a Autenticação Anônima.
        
        const localFirebaseConfig = {
            // Substitua 'SUA_API_KEY' pela sua chave real
            apiKey: "SUA_API_KEY", 
            // Substitua 'SEU_AUTH_DOMAIN' pelo seu domínio de autenticação
            authDomain: "SEU_AUTH_DOMAIN",
            // Substitua 'SEU_PROJECT_ID' pelo seu ID de projeto
            projectId: "SEU_PROJECT_ID", 
            // ... adicione outras chaves se necessário
        };
        // Se estiver rodando fora do Canvas, o token e o ID do app serão nulos e a
        // configuração local será usada.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
                               ? JSON.parse(__firebase_config) 
                               : localFirebaseConfig;
        
        // --- FIM: BLOCO DE CONFIGURAÇÃO PARA USO EXTERNO ---


        // Configura o nível de log do Firestore para DEBUG para ajudar na depuração
        setLogLevel('Debug');

        let app, db, auth;
        let userId = null;
        let allDonativos = []; // Armazena todos os donativos brutos
        let filterDate = null; // Armazena o filtro de mês/ano no formato YYYY-MM
        let activeTab = 'lancamento'; 
        const COLLECTION_NAME = "donativos";
        
        // Elementos UI
        const messagesEl = document.getElementById('system-messages');
        const formEl = document.getElementById('donativo-form');
        const submitButtonEl = document.getElementById('submit-button');
        const donativosBodyEl = document.getElementById('donativos-body');
        const dadosLoadingEl = document.getElementById('dados-loading');
        const donativosTableContainerEl = document.getElementById('donativos-table-container');
        const donativosEmptyEl = document.getElementById('donativos-empty');
        const donativosFilteredEmptyEl = document.getElementById('donativos-filtered-empty');
        
        // Elementos de Relatório
        const totalGeralEl = document.getElementById('total-geral');
        const totalLocalEl = document.getElementById('total-local');
        const totalMundialEl = document.getElementById('total-mundial');

        // Elementos do Filtro
        const filterMonthYearEl = document.getElementById('filter-month-year');
        const filterButtonEl = document.getElementById('filter-button');
        
        // Elementos do Modal de Edição
        const editModalEl = document.getElementById('edit-modal');
        const editModalContentEl = document.getElementById('edit-modal-content');
        const editFormEl = document.getElementById('edit-donativo-form');
        const saveEditButtonEl = document.getElementById('save-edit-button');


        // Funções de UI
        // ---------------------------------------------------------------------

        // Função de utilidade para formatar valores como moeda BRL
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        // Função de utilidade para exibir mensagens na UI
        function showMessage(message, type = 'success') {
            messagesEl.textContent = message;
            messagesEl.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'border-red-400', 'border-green-400', 'text-red-700', 'text-green-700');
            
            if (type === 'success') {
                messagesEl.classList.add('bg-green-100', 'border', 'border-green-400', 'text-green-700');
            } else if (type === 'error') {
                messagesEl.classList.add('bg-red-100', 'border', 'border-red-400', 'text-red-700');
            }
            messagesEl.classList.remove('hidden');
            
            // Oculta a mensagem após 5 segundos
            setTimeout(() => {
                messagesEl.classList.add('hidden');
            }, 5000);
        }

        /**
         * Alterna entre as abas e atualiza o estilo do botão.
         * @param {string} tabName - Nome da aba a ser ativada ('lancamento' ou 'visualizacao').
         */
        window.setActiveTab = (tabName) => {
            activeTab = tabName;
            
            // Atualiza os estilos dos botões
            document.querySelectorAll('.tab-button').forEach(button => {
                const isActive = button.id === `tab-${tabName}`;
                button.classList.toggle('bg-indigo-600', isActive);
                button.classList.toggle('text-white', isActive);
                button.classList.toggle('bg-gray-100', !isActive);
                button.classList.toggle('text-gray-600', !isActive);
            });

            // Atualiza a visibilidade do conteúdo
            document.querySelectorAll('.tab-content').forEach(content => {
                const isVisible = content.id === `tab-content-${tabName}`;
                content.classList.toggle('hidden', !isVisible);
            });
        };

        // Funções do Modal
        window.openEditModal = (doc) => {
            // Preenche o formulário do modal com os dados do donativo
            document.getElementById('edit-donativo-id').value = doc.id;
            document.getElementById('edit-responsavel').value = doc.responsavel;
            document.getElementById('edit-ajudante').value = doc.ajudante;
            document.getElementById('edit-diaReuniao').value = doc.diaReuniao;
            document.getElementById('edit-dataColeta').value = doc.dataColeta;
            document.getElementById('edit-valor').value = doc.valor;
            document.getElementById('edit-destino').value = doc.destino;

            // Mostra o modal com animação
            editModalEl.classList.remove('hidden');
            setTimeout(() => {
                editModalContentEl.classList.remove('scale-95', 'opacity-0');
                editModalContentEl.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        window.closeEditModal = () => {
            // Esconde o modal com animação
            editModalContentEl.classList.add('scale-95', 'opacity-0');
            editModalContentEl.classList.remove('scale-100', 'opacity-100');
            setTimeout(() => {
                editModalEl.classList.add('hidden');
            }, 300);
        };


        // Funções de Dados (Firebase)
        // ---------------------------------------------------------------------
        
        /**
         * Exporta os donativos visíveis (filtrados ou todos) para um arquivo CSV.
         */
        window.exportToCSV = () => {
            // 1. Filtragem dos Dados 
            let dataToExport = allDonativos;
            let fileName = 'donativos_todos';

            if (filterDate) {
                // Filtra os dados brutos com base no filtro de Mês e Ano ativo (YYYY-MM)
                dataToExport = allDonativos.filter(doc => doc.dataColeta && doc.dataColeta.startsWith(filterDate));
                fileName = `donativos_${filterDate.replace('-', '_')}`;
            }

            if (dataToExport.length === 0) {
                showMessage('Não há dados para exportar com o filtro atual.', 'error');
                return;
            }

            // 2. Define o cabeçalho CSV e as chaves de dados
            // Usamos o ponto e vírgula (;) como delimitador, comum no Brasil.
            const headers = ["ID", "Responsável", "Ajudante", "Reunião", "Data Coleta", "Valor", "Destino", "Data Lançamento"];
            // Mapeamento das chaves do objeto para a ordem do CSV
            const keys = ["id", "responsavel", "ajudante", "diaReuniao", "dataColeta", "valor", "destino", "createdAt"];
            
            let csvContent = headers.join(";") + "\n";

            // 3. Mapeia os dados para linhas CSV
            dataToExport.forEach(item => {
                const row = keys.map(key => {
                    let value = item[key];
                    
                    // Tratamento especial para Valor
                    if (key === 'valor') {
                        // Formato Brasileiro: usa vírgula como separador decimal e ponto como separador de milhares.
                        value = (value || 0).toFixed(2).replace('.', ',');
                    } 
                    // Tratamento especial para Timestamp
                    else if (key === 'createdAt' && value && value.toDate) {
                         // Converte o objeto Timestamp do Firestore para string de data/hora local
                         value = value.toDate().toLocaleString('pt-BR');
                    }
                    // Sanitização de strings: remove aspas duplas, ponto e vírgula e excesso de espaços.
                    else if (typeof value === 'string') {
                        value = value.replace(/"/g, '""').replace(/;/g, ',').trim();
                    }
                    
                    // Retorna o valor, entre aspas duplas (padrão CSV para segurança)
                    return `"${value}"`;
                });
                csvContent += row.join(";") + "\n";
            });

            // 4. Cria e baixa o arquivo CSV
            // Adiciona BOM (\uFEFF) para garantir que caracteres especiais (como ç, ã) sejam lidos corretamente no Excel
            const BOM = "\uFEFF";
            const blobWithBOM = new Blob([BOM, csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");

            if (link.download !== undefined) { 
                // Navegadores modernos
                const url = URL.createObjectURL(blobWithBOM);
                link.setAttribute("href", url);
                // Nome do arquivo: donativos_MES_ANO_YYYY-MM-DD.csv
                link.setAttribute("download", `${fileName}_${new Date().toISOString().slice(0, 10)}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage("Dados exportados com sucesso para CSV!", 'success');
            } else {
                showMessage("Seu navegador não suporta download automático. Por favor, copie o conteúdo CSV manualmente.", 'error');
            }
        };

        /**
         * Aplica o filtro de mês/ano selecionado e renderiza os dados.
         */
        window.applyFilter = () => {
            const selectedDate = filterMonthYearEl.value; // Formato YYYY-MM
            
            if (selectedDate) {
                filterDate = selectedDate;
                filterButtonEl.textContent = `Filtrando: ${selectedDate}`;
                filterButtonEl.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                filterButtonEl.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                showMessage(`Filtro aplicado para o mês: ${selectedDate}.`, 'success');
            } else {
                showMessage("Por favor, selecione um Mês e Ano para aplicar o filtro.", 'error');
                return;
            }

            // Re-renderiza a lista com o novo filtro aplicado
            renderDonativos(allDonativos);
        };
        
        /**
         * Reseta o filtro de mês/ano e renderiza todos os dados.
         */
        window.resetFilter = () => {
            filterDate = null;
            filterMonthYearEl.value = '';
            filterButtonEl.textContent = "Aplicar Filtro";
            filterButtonEl.classList.add('bg-teal-600', 'hover:bg-teal-700');
            filterButtonEl.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            
            // Re-renderiza a lista sem filtro
            renderDonativos(allDonativos);
            showMessage("Filtro resetado. Visualizando todos os donativos.", 'success');
        };

        /**
         * Atualiza os cartões de resumo com os totais calculados.
         * @param {number} geral - Total geral.
         * @param {number} local - Total para Congregação Local.
         * @param {number} mundial - Total para Obra Mundial.
         */
        function updateReportCards(geral, local, mundial) {
            totalGeralEl.textContent = formatCurrency(geral);
            totalLocalEl.textContent = formatCurrency(local);
            totalMundialEl.textContent = formatCurrency(mundial);
        }

        /**
         * Retorna o caminho completo de um documento no Firestore.
         * @param {string} docId - ID do documento.
         * @returns {string} O caminho do documento.
         */
        function getDonativoDocPath(docId) {
            // O caminho é baseado no APP ID e no User ID (necessário para as regras de segurança)
            return `/artifacts/${appId}/users/${userId}/${COLLECTION_NAME}/${docId}`;
        }

        /**
         * Exclui um donativo do Firestore.
         * @param {string} docId - ID do documento a ser excluído.
         */
        window.deleteDonativo = async (docId) => {
            // Usando modal customizado para confirmação (preferido em produção)
            if (!confirm('Tem certeza que deseja EXCLUIR este donativo? Esta ação é irreversível.')) {
                return;
            }

            try {
                const docRef = doc(db, getDonativoDocPath(docId));
                await deleteDoc(docRef);
                showMessage("Donativo excluído com sucesso!", 'success');
            } catch (error) {
                console.error("ERRO AO EXCLUIR DONATIVO:", error);
                showMessage(`Erro ao excluir: ${error.message}`, 'error');
            }
        };

        /**
         * Salva as alterações de um donativo.
         */
        async function saveEditedDonativo(event) {
            event.preventDefault();
            saveEditButtonEl.disabled = true;
            saveEditButtonEl.textContent = "Salvando...";

            const docId = document.getElementById('edit-donativo-id').value;
            
            try {
                const updatedData = {
                    responsavel: document.getElementById('edit-responsavel').value,
                    ajudante: document.getElementById('edit-ajudante').value,
                    diaReuniao: document.getElementById('edit-diaReuniao').value,
                    dataColeta: document.getElementById('edit-dataColeta').value,
                    valor: parseFloat(document.getElementById('edit-valor').value) || 0,
                    destino: document.getElementById('edit-destino').value,
                    updatedAt: serverTimestamp() // Adiciona timestamp de atualização
                };

                const docRef = doc(db, getDonativoDocPath(docId));
                await updateDoc(docRef, updatedData);
                
                showMessage("Donativo atualizado com sucesso!", 'success');
                closeEditModal();

            } catch (error) {
                console.error("ERRO AO SALVAR EDIÇÃO:", error);
                showMessage(`Erro ao salvar edição: ${error.message}`, 'error');
            } finally {
                saveEditButtonEl.disabled = false;
                saveEditButtonEl.textContent = "Salvar Alterações";
            }
        }


        /**
         * Renderiza a lista de donativos na tabela e calcula os relatórios.
         * @param {Array<Object>} donativos - Array de donativos com a chave 'id'.
         */
        function renderDonativos(donativos) {
            
            // 1. Filtragem (em memória)
            let filteredDonativos = donativos;
            if (filterDate) {
                // filterDate é YYYY-MM
                filteredDonativos = donativos.filter(doc => doc.dataColeta && doc.dataColeta.startsWith(filterDate));
            }

            // 2. Cálculo dos Totais
            let totalGeral = 0;
            let totalLocal = 0;
            let totalMundial = 0;

            filteredDonativos.forEach(doc => {
                const valor = doc.valor || 0;
                totalGeral += valor;
                if (doc.destino === 'Congregação Local') {
                    totalLocal += valor;
                } else if (doc.destino === 'Obra Mundial') {
                    totalMundial += valor;
                }
            });

            // 3. Atualiza os Cartões de Relatório
            updateReportCards(totalGeral, totalLocal, totalMundial);

            // 4. Renderização da Tabela
            donativosBodyEl.innerHTML = ''; // Limpa a tabela
            
            // Visibilidade da tabela e mensagens
            dadosLoadingEl.classList.add('hidden');
            donativosFilteredEmptyEl.classList.add('hidden');
            donativosEmptyEl.classList.add('hidden');

            if (donativos.length === 0) {
                donativosTableContainerEl.classList.add('hidden');
                donativosEmptyEl.classList.remove('hidden');
                return;
            }

            if (filteredDonativos.length === 0) {
                donativosTableContainerEl.classList.add('hidden');
                donativosFilteredEmptyEl.classList.remove('hidden');
                return;
            }

            // Ordena os donativos pela data (do mais recente para o mais antigo)
            filteredDonativos.sort((a, b) => new Date(b.dataColeta) - new Date(a.dataColeta));
            
            filteredDonativos.forEach(doc => {
                const valor = doc.valor || 0;
                const dataFormatada = new Date(doc.dataColeta + 'T00:00:00').toLocaleDateString('pt-BR');
                const valorFormatado = formatCurrency(valor);
                
                const newRow = document.createElement('tr');
                newRow.classList.add('hover:bg-indigo-50', 'transition', 'duration-100');
                
                // Os dados do donativo são stringificados para serem passados para a função openEditModal
                const donativoJson = JSON.stringify(doc).replace(/'/g, "\\'"); // Escapa aspas simples
                
                newRow.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${dataFormatada}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.responsavel} / ${doc.ajudante}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.diaReuniao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${doc.destino}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-right text-indigo-800">${valorFormatado}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick='openEditModal(${donativoJson})' 
                            class="text-indigo-600 hover:text-indigo-900 mr-3 p-1 rounded hover:bg-indigo-100 transition duration-150">
                            Editar
                        </button>
                        <button onclick="deleteDonativo('${doc.id}')" 
                            class="text-red-600 hover:text-red-900 p-1 rounded hover:bg-red-100 transition duration-150">
                            Excluir
                        </button>
                    </td>
                `;
                donativosBodyEl.appendChild(newRow);
            });

            donativosTableContainerEl.classList.remove('hidden');
        }

        /**
         * Configura o listener em tempo real para os donativos (onSnapshot).
         */
        function setupDonativosListener() {
            if (!db || !userId) {
                console.error("Firestore ou UserID não disponível para o listener.");
                return;
            }

            const collectionPath = `/artifacts/${appId}/users/${userId}/${COLLECTION_NAME}`;
            
            // Cria a query da coleção
            const donativosQuery = query(collection(db, collectionPath));

            // Configura o onSnapshot (escuta todos os dados)
            onSnapshot(donativosQuery, (snapshot) => {
                const donativos = [];
                snapshot.forEach(doc => {
                    donativos.push({
                        id: doc.id,
                        // Copia todos os campos do documento.
                        ...doc.data()
                    });
                });
                
                console.log(`Dados brutos carregados: ${donativos.length} donativos.`);
                allDonativos = donativos; // Armazena todos os dados brutos
                renderDonativos(allDonativos); // Renderiza com base no filtro atual
            }, (error) => {
                console.error("Erro ao obter donativos em tempo real:", error);
                showMessage(`Erro ao carregar lista de donativos: ${error.message}`, 'error');
                dadosLoadingEl.classList.add('hidden');
                donativosEmptyEl.classList.remove('hidden');
            });
        }


        /**
         * Salva os dados do formulário de Novo Donativo no Firestore.
         */
        async function salvarDonativo(event) {
            event.preventDefault();
            
            if (!userId || !db) {
                showMessage("Erro: O sistema ainda não está pronto ou o usuário não está autenticado.", 'error');
                return;
            }

            submitButtonEl.disabled = true;
            submitButtonEl.textContent = "Salvando...";
            
            try {
                // Captura os dados do formulário
                const donativoData = {
                    responsavel: document.getElementById('responsavel').value,
                    ajudante: document.getElementById('ajudante').value,
                    diaReuniao: document.getElementById('diaReuniao').value,
                    dataColeta: document.getElementById('dataColeta').value, // Formato YYYY-MM-DD
                    valor: parseFloat(document.getElementById('valor').value) || 0, 
                    destino: document.getElementById('destino').value,
                    
                    // Metadados importantes para o Firestore
                    userId: userId,
                    createdAt: serverTimestamp() 
                };

                const collectionPath = `/artifacts/${appId}/users/${userId}/${COLLECTION_NAME}`;
                
                await addDoc(collection(db, collectionPath), donativoData);
                
                showMessage("Donativo salvo com sucesso! Veja os relatórios e a lista atualizada na aba 'Visualização'.", 'success');
                formEl.reset(); // Limpa o formulário após o sucesso

            } catch (error) {
                console.error("ERRO AO SALVAR DONATIVO:", error);
                showMessage(`Erro ao salvar: ${error.message}`, 'error');
            } finally {
                submitButtonEl.disabled = false;
                submitButtonEl.textContent = "Salvar Donativo";
            }
        }


        // Funções de Inicialização e Autenticação
        // ---------------------------------------------------------------------

        /**
         * Tenta fazer o login com o token personalizado usando Exponential Backoff.
         */
        async function signInWithBackoff(auth, token, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    console.log(`Tentativa de login ${i + 1}...`);
                    if (token) {
                        return await signInWithCustomToken(auth, token);
                    } else {
                        // Faz login anônimo. Necessário habilitar Autenticação Anônima no Firebase.
                        return await signInAnonymously(auth);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error; 
                    }
                    console.warn(`Falha na tentativa ${i + 1}. Tentando novamente em ${delay / 1000}s.`, error.message);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
        }

        /**
         * Inicializa o Firebase, o Firestore e a Autenticação.
         */
        async function initializeFirebaseAndAuth() {
            try {
                // 1. Verifica Configurações 
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || firebaseConfig.apiKey === "SUA_API_KEY") {
                    // O erro só será disparado se não estiver rodando no Canvas (onde a config é garantida)
                    if (typeof __firebase_config === 'undefined') {
                        throw new Error("Configuração do Firebase não encontrada ou vazia. Por favor, forneça sua configuração para rodar fora do Canvas.");
                    }
                }

                // 2. Inicializa App e Serviços
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                window.db = db;
                window.auth = auth;

                // 3. Listener de Estado de Autenticação (CRUCIAL)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid; // Armazena o ID do usuário
                        console.log("SUCESSO: Usuário autenticado:", userId);
                        
                        // 4. Se a autenticação estiver pronta, esconde a tela de loading
                        document.getElementById('user-id-display').textContent = userId;
                        document.getElementById('loading-screen').classList.add('opacity-0');
                        setTimeout(() => {
                            document.getElementById('loading-screen').classList.add('hidden');
                            document.getElementById('main-app').classList.remove('hidden');
                            
                            // 5. Configura Listeners de Eventos e de Dados APÓS o carregamento da APP
                            formEl.addEventListener('submit', salvarDonativo);
                            editFormEl.addEventListener('submit', saveEditedDonativo);
                            setupDonativosListener(); // INICIA O LISTENER DE DADOS
                            setActiveTab('lancamento'); // Define a aba inicial
                        }, 300); 
                    } else {
                        console.log("Estado de autenticação alterado para não logado.");
                    }
                });

                // 4. Tentativa de Login Inicial
                if (initialAuthToken) {
                    await signInWithBackoff(auth, initialAuthToken);
                } else {
                    console.log("Token de autenticação não disponível. Tentando login anônimo...");
                    // Nota: signInWithBackoff(auth, null) faz o login anônimo se o token for null.
                    await signInWithBackoff(auth, null); 
                }

            } catch (error) {
                console.error("ERRO FATAL NA INICIALIZAÇÃO:", error);
                const loadingScreen = document.getElementById('loading-screen');
                loadingScreen.classList.remove('opacity-0', 'hidden'); 
                loadingScreen.innerHTML = `
                    <div class="p-6 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-lg max-w-sm text-center shadow-lg">
                        <h2 class="text-xl font-bold mb-2">🚨 ERRO FATAL DE SISTEMA</h2>
                        <p class="text-sm">Falha ao inicializar o Firebase. Verifique o console para detalhes técnicos. Causa: ${error.message}</p>
                    </div>
                `;
            }
        }

        window.addEventListener('load', initializeFirebaseAndAuth);

    </script>
</body>
</html>
