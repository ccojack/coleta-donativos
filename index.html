<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro do Salão do Reino</title>
    <!-- Carrega Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração de Fonte -->
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen p-4 sm:p-8">
        <!-- O conteúdo será injetado aqui pelo JavaScript -->
        <div class="flex items-center justify-center min-h-screen">
            <div class="flex items-center text-indigo-600 text-xl font-medium">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                Carregando sistema...
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação (Inicialmente oculto) -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300 scale-100">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-700 font-medium rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition">Confirmar Exclusão</button>
            </div>
        </div>
    </div>

    <!-- Bibliotecas Firebase e PDF -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, query, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Carrega bibliotecas de PDF no escopo global para o JS puro
        // A barra em '</script>' deve ser escapada (<\/script>) para evitar SyntaxError no parser HTML/JS.
        document.head.innerHTML += '<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"><\/script>';
        document.head.innerHTML += '<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"><\/script>';

        // --- VARIÁVEIS GLOBAIS DE ESTADO ---
        let db, auth;
        let userId = null;
        let coletas = [];
        let notasFiscais = [];
        let activeTab = 'coletas';
        let deleteCandidate = { id: null, collectionName: null }; // Para o Modal de Confirmação
        let exportMessageTimeout;

        // Variáveis de Ambiente (do Canvas - NÃO ALTERAR ESTAS LINHAS)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- UTILS ---

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(amount);
        };
        
        const showExportMessage = (text, type) => {
            clearTimeout(exportMessageTimeout);
            let messageDiv = document.getElementById('export-message');
            if (!messageDiv) {
                messageDiv = document.createElement('div');
                messageDiv.id = 'export-message';
                document.body.appendChild(messageDiv);
            }
            
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            const html = `
                <div class="fixed top-4 right-4 p-4 rounded-lg shadow-xl flex items-center ${bgColor} text-white z-50 transition duration-300 transform translate-y-0">
                    <span class="font-semibold">${text}</span>
                    <button onclick="document.getElementById('export-message').remove()" class="ml-4">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            `;
            
            messageDiv.innerHTML = html;
            exportMessageTimeout = setTimeout(() => {
                const element = document.getElementById('export-message');
                if(element) element.remove();
            }, 4000);
        };

        const calculateReportData = () => {
            const totalColetas = coletas.reduce((sum, item) => sum + item.amount, 0);
            const totalDespesas = notasFiscais.reduce((sum, item) => sum + item.amount, 0);
            const saldo = totalColetas - totalDespesas;
            
            const coletasPorDia = coletas.reduce((acc, item) => {
                acc[item.day] = (acc[item.day] || 0) + item.amount;
                return acc;
            }, {});

            const despesasPorCategoria = notasFiscais.reduce((acc, item) => {
                acc[item.category] = (acc[item.category] || 0) + item.amount;
                return acc;
            }, {});

            return { totalColetas, totalDespesas, saldo, coletasPorDia, despesasPorCategoria };
        };

        // --- FIREBASE INIT E LISTENERS ---

        const initFirebase = async () => {
            // VERIFICAÇÃO CRÍTICA DE CONFIGURAÇÃO
            if (Object.keys(firebaseConfig).length === 0) {
                const appDiv = document.getElementById('app');
                appDiv.innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="p-8 text-center bg-white rounded-xl shadow-lg m-auto max-w-xl">
                            <h2 class="text-2xl font-bold text-red-600 mb-4">ERRO: Configuração do Firebase Ausente</h2>
                            <p class="text-gray-700">O sistema depende de uma configuração válida do Firebase (que é injetada automaticamente no ambiente Canvas).</p>
                            <p class="mt-3 text-sm text-gray-500">Se você estiver rodando este código fora do Canvas (ex: GitHub), você deve substituir o <code>{}</code> na variável <code>firebaseConfig</code> (linha ~45) pela sua própria configuração real do Firebase para a aplicação funcionar.</p>
                            <a href="https://firebase.google.com/" target="_blank" class="mt-4 inline-block text-indigo-600 hover:text-indigo-800 font-medium">Saiba mais sobre o Firebase</a>
                        </div>
                    </div>
                `;
                console.error("ERRO CRÍTICO: Configuração do Firebase está vazia. A aplicação não pode inicializar o Firebase. Por favor, forneça uma configuração válida se estiver fora do ambiente Canvas.");
                return; // Interrompe a execução para evitar a falha de initializeApp
            }

            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                const authenticate = async () => {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                            console.error("Custom Token Sign-In Failed, signing in anonymously:", e);
                            return signInAnonymously(auth);
                        });
                    } else {
                        await signInAnonymously(auth).catch(e => {
                            console.error("Anonymous Sign-In Failed:", e);
                        });
                    }
                };
                
                // Monitora o estado de autenticação
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        setupFirestoreListeners();
                    } else {
                        authenticate();
                    }
                    render(); // Renderiza a interface após a autenticação
                });

                authenticate();

            } catch (error) {
                console.error("Erro na inicialização do Firebase:", error);
                document.getElementById('app').innerHTML = `<div class="p-8 text-center text-red-600">Erro ao iniciar Firebase. Verifique a configuração no console.</div>`;
            }
        };

        const setupFirestoreListeners = () => {
            if (!db || !userId) return;

            // Coletas
            const coletasRef = collection(db, `/artifacts/${appId}/users/${userId}/coletas`);
            onSnapshot(query(coletasRef), (snapshot) => {
                coletas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render(); 
            }, (error) => {
                console.error("Erro ao ouvir coletas:", error);
            });

            // Notas Fiscais
            const notasRef = collection(db, `/artifacts/${appId}/users/${userId}/notasFiscais`);
            onSnapshot(query(notasRef), (snapshot) => {
                notasFiscais = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                render(); 
            }, (error) => {
                console.error("Erro ao ouvir notas fiscais:", error);
            });
        };

        // --- CRIAÇÃO DE ELEMENTOS HTML ---

        // Função genérica para criar cards de estatísticas
        const createStatCard = (title, value, iconHtml, color) => `
            <div class="p-5 rounded-xl shadow-lg ${color} flex flex-col justify-between text-white">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-medium opacity-80">${title}</h3>
                    ${iconHtml}
                </div>
                <p class="text-3xl font-bold mt-2">${value}</p>
            </div>
        `;

        // Função para renderizar a lista de transações
        const renderTransactionList = (title, items, isIncome) => {
            const listHtml = items
                .filter(item => item.createdAt && typeof item.createdAt.toDate === 'function')
                .sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate())
                .map(item => {
                    const dateStr = item.collectionDate 
                        ? new Date(item.collectionDate).toLocaleDateString('pt-BR') 
                        : (item.issueDate 
                            ? new Date(item.issueDate).toLocaleDateString('pt-BR') 
                            : 'Data Indefinida');
                    
                    const mainDetail = isIncome 
                        ? `${item.type} | Resp: ${item.responsible || 'N/A'}`
                        : `${item.supplier}`;
                    
                    const secondaryDetail = isIncome 
                        ? `Data: ${dateStr} | Dia: ${item.day}`
                        : `NF: ${item.invoiceNumber} | Categoria: ${item.category}`;
                    
                    const extraDetail = isIncome && item.accompaniedBy 
                        ? `<span class="text-xs text-gray-400 block">Acomp: ${item.accompaniedBy}</span>`
                        : '';

                    const valueColor = isIncome ? 'text-green-600' : 'text-red-600';
                    const borderColor = isIncome ? 'border-indigo-500' : 'border-red-500';

                    const deleteButton = isIncome ? `
                        <button onclick="handleDeleteRequest('${item.id}', 'coletas')" title="Excluir Coleta" class="p-2 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition duration-150 flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.013 21H7.987a2 2 0 01-1.92-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>` : '';

                    const linkButton = !isIncome && item.documentLink ? `
                        <a href="${item.documentLink}" target="_blank" rel="noopener noreferrer" title="Visualizar Documento Anexado" class="p-2 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition duration-150 flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                        </a>` : '';

                    return `
                        <div class="p-3 border-l-4 ${borderColor} bg-gray-50 rounded-lg shadow-sm flex justify-between items-center transition duration-150 hover:bg-gray-100">
                            <div class="flex flex-col">
                                <span class="font-semibold text-gray-900">${mainDetail}</span>
                                <span class="text-sm text-gray-500">${secondaryDetail}</span>
                                ${extraDetail}
                            </div>
                            <div class="text-right flex items-center space-x-3">
                                ${isIncome ? deleteButton : ''}
                                ${!isIncome ? linkButton : ''}
                                <div> 
                                    <span class="font-bold ${valueColor} block">${formatCurrency(item.amount)}</span>
                                    <span class="text-xs text-gray-400 block">${item.createdAt ? item.createdAt.toDate().toLocaleTimeString('pt-BR') : ''}</span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            return `
                <div class="bg-white p-6 rounded-xl shadow-2xl mt-8">
                    <h2 class="text-xl font-bold mb-4 ${isIncome ? 'text-indigo-700' : 'text-red-700'}">${title}</h2>
                    ${items.length === 0 
                        ? '<p class="text-gray-500 italic">Nenhum registro encontrado.</p>' 
                        : `<div class="space-y-3 max-h-96 overflow-y-auto pr-2">${listHtml}</div>`
                    }
                </div>
            `;
        };

        // Função para o Formulário de Coleta
        const renderColetaForm = () => {
            const donationTypes = ['Donativos para Obra Mundial', 'Donativos para Congregação'];
            return `
                <form id="coleta-form" class="p-6 bg-white rounded-xl shadow-2xl">
                    <h2 class="text-xl font-bold mb-6 text-indigo-700 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2l-1 5h11l1-5h-1a2 2 0 002-2V9a2 2 0 00-2-2h-4"></path></svg>
                        Registrar Nova Coleta
                    </h2>
                    
                    <!-- Responsáveis -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Responsável pela Coleta <span class="text-red-500">*</span></label>
                            <input type="text" id="coleta-responsible" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nome do responsável" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Acompanhado por <span class="text-red-500">*</span></label>
                            <input type="text" id="coleta-accompaniedBy" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Nome do acompanhante" required />
                        </div>
                    </div>

                    <!-- Data e Dia da Semana -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Data da Coleta <span class="text-red-500">*</span></label>
                            <input type="date" id="coleta-date" value="${new Date().toISOString().split('T')[0]}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Dia da Semana</label>
                            <select id="coleta-day" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="Quarta">Quarta-feira</option>
                                <option value="Sábado">Sábado</option>
                                <option value="Domingo">Domingo (Extra)</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <!-- Valor -->
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$) <span class="text-red-500">*</span></label>
                            <input type="text" id="coleta-amount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ex: 500.50" required />
                        </div>

                        <!-- Tipo -->
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Donativo</label>
                            <select id="coleta-type" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                                ${donationTypes.map(dType => `<option value="${dType}">${dType}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <!-- Forma de Pagamento -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Forma de Pagamento</label>
                            <select id="coleta-paymentMethod" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="Dinheiro">Dinheiro (Cédulas/Moedas)</option>
                                <option value="PIX">PIX</option>
                                <option value="Transferencia">Transferência Bancária</option>
                                <option value="Cartao">Cartão de Débito/Crédito</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Observações -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observações (Opcional)</label>
                        <textarea id="coleta-notes" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Detalhes da contagem, etc."></textarea>
                    </div>

                    <button type="submit" id="coleta-submit-btn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Salvar Coleta
                    </button>

                    <p id="coleta-message" class="mt-3 text-center text-sm font-medium"></p>
                </form>
            `;
        };
        
        // Função para o Formulário de Nota Fiscal
        const renderNotaFiscalForm = () => {
            const categories = ['Contas Fixas', 'Material de Limpeza', 'Manutenção', 'Eventos', 'Administrativo', 'Outros'];
            return `
                <form id="nota-fiscal-form" class="p-6 bg-white rounded-xl shadow-2xl">
                    <h2 class="text-xl font-bold mb-6 text-red-700 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Registrar Nova Nota Fiscal
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Número da NF/Documento</label>
                            <input type="text" id="nf-number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Ex: 123456" required />
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fornecedor</label>
                            <input type="text" id="nf-supplier" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Ex: Supermercado Central" required />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                            <input type="text" id="nf-amount" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Ex: 125.99" required />
                        </div>
                        <div class="col-span-1">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Categoria do Gasto</label>
                            <select id="nf-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" required>
                                ${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Link do Documento/Anexo (URL Opcional)</label>
                        <input type="url" id="nf-documentLink" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Ex: https://link.para.o.pdf" />
                        <p class="text-xs text-gray-500 mt-1">* Salve o PDF/Imagem em um serviço externo (Drive, Dropbox) e cole o link aqui.</p>
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observações (Opcional)</label>
                        <textarea id="nf-notes" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500" placeholder="Detalhes sobre a despesa, quem autorizou, etc."></textarea>
                    </div>

                    <button type="submit" id="nf-submit-btn" class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Salvar Nota Fiscal
                    </button>

                    <p id="nf-message" class="mt-3 text-center text-sm font-medium"></p>
                </form>
            `;
        };
        
        // Função para renderizar a aba de Relatórios
        const renderRelatoriosTab = () => {
            const report = calculateReportData();

            // Ícones SVG
            const iconDollar = '<svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8h.01M12 18h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
            const iconFile = '<svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>';
            const iconZap = '<svg class="w-6 h-6 opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>';
            const iconCalendar = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-4 10h.01M12 17h.01M16 17h.01M16 13h.01M16 3H8a2 2 0 00-2 2v14a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2z"></path></svg>';
            const iconTag = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h10a2 2 0 012 2v10a2 2 0 01-2 2h-4l-4 4v-4H7a2 2 0 01-2-2V5a2 2 0 012-2z"></path></svg>';

            // Cards de Estatísticas
            const statCards = `
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                    ${createStatCard("Total de Coletas (Entradas)", formatCurrency(report.totalColetas), iconDollar, "bg-indigo-600")}
                    ${createStatCard("Total de Notas Fiscais (Saídas)", formatCurrency(report.totalDespesas), iconFile, "bg-red-600")}
                    ${createStatCard("Saldo Atual", formatCurrency(report.saldo), iconZap, report.saldo >= 0 ? 'bg-green-600' : 'bg-red-700')}
                </div>
            `;
            
            // Coletas por Dia
            const coletasDiaList = Object.keys(report.coletasPorDia).length === 0 
                ? '<p class="text-gray-500 italic">Sem dados de coletas para exibir.</p>' 
                : Object.keys(report.coletasPorDia).map(day => `
                    <li class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">${day}</span>
                        <span class="font-bold text-indigo-600">${formatCurrency(report.coletasPorDia[day])}</span>
                    </li>
                `).join('');

            // Despesas por Categoria
            const despesasCategoriaList = Object.keys(report.despesasPorCategoria).length === 0
                ? '<p class="text-gray-500 italic">Sem dados de despesas para exibir.</p>'
                : Object.keys(report.despesasPorCategoria).map(category => `
                    <li class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                        <span class="font-medium text-gray-700">${category}</span>
                        <span class="font-bold text-red-600">${formatCurrency(report.despesasPorCategoria[category])}</span>
                    </li>
                `).join('');

            return `
                <div class="space-y-8">
                    <h2 class="text-3xl font-bold text-gray-800">Resumo Financeiro</h2>

                    ${statCards}

                    <!-- Botões de Exportação -->
                    <div class="bg-white p-6 rounded-xl shadow-2xl">
                        <h3 class="text-xl font-bold mb-4 text-gray-800">Exportar Dados Brutos</h3>
                        <p class="text-sm text-gray-500 mb-4">Selecione o tipo de dado e o formato para exportação:</p>
                        <div class="flex flex-wrap gap-4">
                            <button onclick="exportToCSV(coletas, 'coletas_registro.csv', 'coletas')" class="flex items-center px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 transition shadow-md">Coletas (CSV)</button>
                            <button onclick="exportToPDF(coletas, 'Relatório de Coletas', 'coletas_registro.pdf', 'coletas')" class="flex items-center px-4 py-2 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600 transition shadow-md">Coletas (PDF)</button>
                            <button onclick="exportToCSV(notasFiscais, 'despesas_registro.csv', 'notasFiscais')" class="flex items-center px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition shadow-md">Despesas (CSV)</button>
                            <button onclick="exportToPDF(notasFiscais, 'Relatório de Despesas', 'despesas_registro.pdf', 'notasFiscais')" class="flex items-center px-4 py-2 bg-red-500 text-white font-medium rounded-lg hover:bg-red-600 transition shadow-md">Despesas (PDF)</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Coletas por Dia -->
                        <div class="bg-white p-6 rounded-xl shadow-2xl">
                            <h3 class="text-xl font-bold mb-4 text-indigo-700 flex items-center">${iconCalendar} Coletas por Dia de Evento</h3>
                            <ul class="space-y-3">${coletasDiaList}</ul>
                        </div>

                        <!-- Despesas por Categoria -->
                        <div class="bg-white p-6 rounded-xl shadow-2xl">
                            <h3 class="text-xl font-bold mb-4 text-red-700 flex items-center">${iconTag} Despesas por Categoria</h3>
                            <ul class="space-y-3">${despesasCategoriaList}</ul>
                        </div>
                    </div>
                </div>
            `;
        };
        
        // --- FUNÇÃO DE RENDERIZAÇÃO PRINCIPAL ---

        const render = () => {
            if (!userId) {
                 document.getElementById('app').innerHTML = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="flex items-center text-indigo-600 text-xl font-medium">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                            Autenticando usuário...
                        </div>
                    </div>
                `;
                return;
            }

            const report = calculateReportData();

            // Cabeçalho
            let headerHtml = `
                <header class="mb-8 text-center">
                    <h1 class="text-4xl font-extrabold text-gray-900">
                        Controle Financeiro do <span class="text-indigo-600">Salão do Reino</span>
                    </h1>
                    <p class="text-gray-500 mt-1">
                        Gerencie Coletas (${formatCurrency(report.totalColetas)}) e Notas Fiscais (${formatCurrency(report.totalDespesas)})
                    </p>
                    <p class="text-xs mt-2 p-1 bg-gray-200 inline-block rounded-md text-gray-700">
                        ID de Usuário: ${userId}
                    </p>
                </header>
            `;

            // Navegação por Abas
            let navHtml = `
                <div class="max-w-6xl mx-auto mb-8 bg-white p-2 rounded-xl shadow-lg flex flex-wrap sm:flex-nowrap justify-around">
                    <button onclick="setActiveTab('coletas')" class="flex-1 flex justify-center items-center py-3 px-4 text-lg font-semibold rounded-lg transition duration-200 m-1 ${activeTab === 'coletas' ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}">
                        Coletas (Donativos)
                    </button>
                    <button onclick="setActiveTab('notas')" class="flex-1 flex justify-center items-center py-3 px-4 text-lg font-semibold rounded-lg transition duration-200 m-1 ${activeTab === 'notas' ? 'bg-red-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}">
                        Notas Fiscais (Despesas)
                    </button>
                    <button onclick="setActiveTab('relatorios')" class="flex-1 flex justify-center items-center py-3 px-4 text-lg font-semibold rounded-lg transition duration-200 m-1 ${activeTab === 'relatorios' ? 'bg-green-600 text-white shadow-md' : 'text-gray-600 hover:bg-gray-100'}">
                        Relatórios
                    </button>
                </div>
            `;

            // Conteúdo Principal
            let mainContent = '';
            if (activeTab === 'coletas') {
                mainContent = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">${renderColetaForm()}</div>
                        <div class="lg:col-span-2">${renderTransactionList("Últimas Coletas Registradas", coletas, true)}</div>
                    </div>
                `;
            } else if (activeTab === 'notas') {
                mainContent = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1">${renderNotaFiscalForm()}</div>
                        <div class="lg:col-span-2">${renderTransactionList("Últimas Notas Fiscais Registradas", notasFiscais, false)}</div>
                    </div>
                `;
            } else if (activeTab === 'relatorios') {
                mainContent = renderRelatoriosTab();
            }

            document.getElementById('app').innerHTML = `
                ${headerHtml}
                ${navHtml}
                <main class="max-w-6xl mx-auto">${mainContent}</main>
            `;

            // Adiciona listeners após a renderização
            if (activeTab === 'coletas') {
                document.getElementById('coleta-form').addEventListener('submit', handleColetaSubmit);
                document.getElementById('coleta-amount').addEventListener('input', handleAmountInput);
            } else if (activeTab === 'notas') {
                document.getElementById('nota-fiscal-form').addEventListener('submit', handleNotaFiscalSubmit);
                document.getElementById('nf-amount').addEventListener('input', handleAmountInput);
            }

            // Garante que o modal de confirmação esteja pronto para uso
            setupModalListeners();
        };
        
        // --- FUNÇÕES DE INTERAÇÃO E CRUD ---
        
        window.setActiveTab = (tab) => {
            activeTab = tab;
            render();
        };

        const handleAmountInput = (e) => {
            const rawValue = e.target.value.replace(/[^0-9,.]/g, '');
            e.target.value = rawValue.replace(',', '.');
        };

        const handleFormMessage = (id, message, isError = false) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.textContent = message;
            el.className = `mt-3 text-center text-sm font-medium ${isError ? 'text-red-600' : 'text-green-600'}`;
        };

        const handleColetaSubmit = async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('coleta-submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0020 12c0-4.418-3.582-8-8-8v5z"></path></svg> Aguarde...';

            try {
                const amount = parseFloat(document.getElementById('coleta-amount').value);
                const responsible = document.getElementById('coleta-responsible').value.trim();
                const accompaniedBy = document.getElementById('coleta-accompaniedBy').value.trim();

                if (isNaN(amount) || amount <= 0) {
                    throw new Error("O valor deve ser um número positivo.");
                }
                if (!responsible || !accompaniedBy) {
                    throw new Error("Os campos Responsável e Acompanhante são obrigatórios.");
                }

                const coletasCollection = collection(db, `/artifacts/${appId}/users/${userId}/coletas`);
                await addDoc(coletasCollection, {
                    amount: amount,
                    type: document.getElementById('coleta-type').value,
                    day: document.getElementById('coleta-day').value,
                    responsible: responsible,
                    accompaniedBy: accompaniedBy,
                    collectionDate: document.getElementById('coleta-date').value,
                    paymentMethod: document.getElementById('coleta-paymentMethod').value,
                    notes: document.getElementById('coleta-notes').value,
                    createdAt: serverTimestamp(),
                });

                handleFormMessage('coleta-message', 'Coleta registrada com sucesso!', false);
                e.target.reset(); // Limpa o formulário

            } catch (error) {
                console.error("Erro ao adicionar coleta:", error);
                handleFormMessage('coleta-message', `Erro ao registrar: ${error.message}`, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Salvar Coleta';
            }
        };

        const handleNotaFiscalSubmit = async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('nf-submit-btn');
            btn.disabled = true;
            btn.innerHTML = '<svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 0020 12c0-4.418-3.582-8-8-8v5z"></path></svg> Aguarde...';

            try {
                const amount = parseFloat(document.getElementById('nf-amount').value);
                const supplier = document.getElementById('nf-supplier').value.trim();

                if (isNaN(amount) || amount <= 0) {
                    throw new Error("O valor deve ser um número positivo.");
                }
                if (!supplier) {
                    throw new Error("O campo Fornecedor é obrigatório.");
                }

                const notasCollection = collection(db, `/artifacts/${appId}/users/${userId}/notasFiscais`);
                await addDoc(notasCollection, {
                    invoiceNumber: document.getElementById('nf-number').value,
                    supplier: supplier,
                    amount: amount,
                    category: document.getElementById('nf-category').value,
                    notes: document.getElementById('nf-notes').value,
                    documentLink: document.getElementById('nf-documentLink').value,
                    issueDate: new Date().toISOString().split('T')[0],
                    createdAt: serverTimestamp(),
                });

                handleFormMessage('nf-message', 'Nota Fiscal registrada com sucesso!', false);
                e.target.reset();

            } catch (error) {
                console.error("Erro ao adicionar nota fiscal:", error);
                handleFormMessage('nf-message', `Erro ao registrar: ${error.message}`, true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Salvar Nota Fiscal';
            }
        };
        
        // --- LÓGICA DE EXCLUSÃO (Modal) ---
        
        window.handleDeleteRequest = (id, collectionName) => {
            deleteCandidate = { id, collectionName };
            document.getElementById('modal-title').textContent = "Confirmar Exclusão";
            document.getElementById('modal-message').textContent = `Você tem certeza que deseja excluir permanentemente o registro de ${collectionName === 'coletas' ? 'Coleta' : 'Nota Fiscal'}? Esta ação não pode ser desfeita.`;
            document.getElementById('confirmation-modal').classList.remove('hidden');
        };

        const handleCancelDelete = () => {
            deleteCandidate = { id: null, collectionName: null };
            document.getElementById('confirmation-modal').classList.add('hidden');
        };

        const handleConfirmDelete = async () => {
            const { id, collectionName } = deleteCandidate;
            handleCancelDelete(); // Fecha o modal

            if (!db || !userId || !id || !collectionName) {
                showExportMessage("Erro: Dados insuficientes para exclusão.", 'error');
                return;
            }
            
            try {
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/${collectionName}`, id);
                await deleteDoc(docRef);
                showExportMessage("Registro excluído com sucesso!", 'success');
            } catch (error) {
                console.error(`Erro ao excluir o documento ${id}:`, error);
                showExportMessage(`Erro ao excluir. Detalhes: ${error.message}`, 'error');
            }
        };

        const setupModalListeners = () => {
            document.getElementById('modal-cancel').onclick = handleCancelDelete;
            document.getElementById('modal-confirm').onclick = handleConfirmDelete;
        };

        // --- LÓGICA DE EXPORTAÇÃO (CSV & PDF) ---

        const mapToExportData = (data, type) => {
            return data.map(item => {
                const base = {
                    'Valor (R$)': formatCurrency(item.amount),
                    'Data Registro': item.createdAt && typeof item.createdAt.toDate === 'function' ? item.createdAt.toDate().toLocaleDateString('pt-BR') : '',
                    'Hora Registro': item.createdAt && typeof item.createdAt.toDate === 'function' ? item.createdAt.toDate().toLocaleTimeString('pt-BR') : '',
                };
                
                if (type === 'coletas') {
                    return {
                        'Tipo': item.type,
                        'Data Coleta': item.collectionDate ? new Date(item.collectionDate).toLocaleDateString('pt-BR') : '',
                        'Dia Semana': item.day,
                        'Responsável': item.responsible,
                        'Acompanhado Por': item.accompaniedBy,
                        'Método Pagamento': item.paymentMethod,
                        'Observações': item.notes,
                        ...base,
                    };
                } else { // notasFiscais
                    return {
                        'Fornecedor': item.supplier,
                        'NF Número': item.invoiceNumber,
                        'Categoria': item.category,
                        'Data NF': item.issueDate ? new Date(item.issueDate).toLocaleDateString('pt-BR') : '',
                        'Link Documento': item.documentLink || 'N/A',
                        'Observações': item.notes,
                        ...base,
                    };
                }
            });
        };

        window.exportToCSV = (data, filename, type) => {
            if (data.length === 0) {
                showExportMessage("Sem dados para exportar.", 'error');
                return;
            }
            
            const exportData = mapToExportData(data, type);

            const header = Object.keys(exportData[0]);
            const csvContent = "data:text/csv;charset=utf-8,\uFEFF"
                + header.join(";") + "\n"
                + exportData.map(row => header.map(key => {
                    let value = row[key] || '';
                    if (typeof value === 'string') {
                        value = value.replace(/"/g, '""').replace(/\n/g, ' ');
                        return `"${value}"`;
                    }
                    return value;
                }).join(";")).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showExportMessage(`Exportado para ${filename} com sucesso!`, 'success');
        };

        window.exportToPDF = (data, title, filename, type) => {
            if (typeof window.jsPDF === 'undefined' || typeof window.autoTable === 'undefined') {
                showExportMessage("As bibliotecas de PDF ainda não carregaram. Tente novamente.", 'error');
                return;
            }
            if (data.length === 0) {
                showExportMessage("Sem dados para exportar.", 'error');
                return;
            }

            // window.jsPDF é acessível globalmente após o carregamento dinâmico
            const doc = new window.jsPDF({ orientation: 'landscape' });
            const exportData = mapToExportData(data, type);
            const report = calculateReportData();

            const columns = Object.keys(exportData[0]);
            const rows = exportData.map(item => Object.values(item));

            doc.setFontSize(16);
            doc.text(title, 14, 15);
            
            doc.setFontSize(10);
            doc.text(`Total de Entradas: ${formatCurrency(report.totalColetas)} | Total de Saídas: ${formatCurrency(report.totalDespesas)} | Saldo: ${formatCurrency(report.saldo)}`, 14, 22);

            doc.autoTable({ 
                head: [columns], 
                body: rows, 
                startY: 28,
                styles: { fontSize: 8, cellPadding: 1.5 },
                headStyles: { fillColor: [51, 65, 85] }
            });

            doc.save(filename);
            showExportMessage(`Exportado para ${filename} com sucesso!`, 'success');
        };

        // --- INICIALIZAÇÃO ---

        // Inicia o Firebase e renderiza a aplicação
        window.onload = initFirebase;
    </script>
</body>
</html>
